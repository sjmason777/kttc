# Управление Глоссариями

**Используйте лингвистические справочные данные для повышения качества проверки переводов.**

Глоссарии предоставляют языкоспецифичные лингвистические знания, которые помогают агентам KTTC проводить более точную оценку качества. Это включает грамматические правила, определения терминов и языкоспецифичные паттерны.

## Обзор

KTTC интегрирует комплексные глоссарии для:

- **MQM Определения Ошибок** - Стандартная таксономия ошибок от W3C Multidimensional Quality Metrics
- **Русская Грамматика** - Падежная система, виды глаголов, частицы
- **Китайские Классификаторы** - Счетные слова (量词) и паттерны использования
- **Грамматика Хинди** - Падежная система (कारक), послелоги, косвенные формы
- **Персидская Грамматика** - Конструкция эзафе (اضافه), сложные глаголы

Эти глоссарии автоматически загружаются и используются агентами качества во время оценки.

## Поддерживаемые Языки

### Определения MQM Core

**Доступно на:** Английский, Русский, Китайский, Хинди, Персидский

Глоссарий MQM (Multidimensional Quality Metrics) предоставляет стандартизированные определения ошибок, используемые всеми агентами.

**Категории ошибок:**
- Точность: ошибки перевода, пропуски, добавления
- Беглость: грамматика, орфография, пунктуация
- Стиль: регистр, формальность, согласованность
- Терминология: ошибки доменоспецифичных терминов

### Глоссарий Русского Языка

**Файл:** `glossaries/ru/grammar_reference.json`

**Содержит:**
- **6 падежей** (именительный, родительный, дательный, винительный, творительный, предложный)
- **Виды глаголов** (правила использования совершенного/несовершенного видов)
- **Частицы** (же, ли, бы, не, ни)
- **Маркеры регистра** (различие ты/вы)

**Используется агентом:** `RussianFluencyAgent`

### Глоссарий Китайского Языка

**Файл:** `glossaries/zh/classifiers.json`

**Содержит:**
- **Индивидуальные классификаторы** (个, 只, 条, 张, 本 и т.д.)
- **Коллективные классификаторы** (群, 堆, 批 и т.д.)
- **Классификаторы контейнеров** (杯, 碗, 盒 и т.д.)
- **Классификаторы измерений** (米, 公斤, 升 и т.д.)
- **Временные классификаторы** (年, 月, 天 и т.д.)
- **Глагольные классификаторы** (次, 遍, 趟 и т.д.)

**Используется агентом:** `ChineseFluencyAgent`

### Глоссарий Хинди

**Файл:** `glossaries/hi/grammar_reference.json`

**Содержит:**
- **8 падежей** (кारक - система kārak)
- **Послелоги** (को, से, में, पर и т.д.)
- **Косвенные формы** (правила образования)
- **Согласование по роду** (паттерны мужского/женского рода)

**Используется агентом:** `HindiFluencyAgent`

### Глоссарий Персидского Языка

**Файл:** `glossaries/fa/grammar_reference.json`

**Содержит:**
- **Конструкция эзафе** (اضافه - правила e-zāfe)
- **Сложные глаголы** (вспомогательные глаголы: کردن, زدن, داشتن и т.д.)
- **Предлоги** (در, به, از и т.д.)
- **Формальный/неформальный регистр** (различие شما/تو)

**Используется агентом:** `PersianFluencyAgent`

## Как Работают Глоссарии

### Автоматическая Интеграция

Глоссарии автоматически загружаются при инициализации агентов:

```python
from kttc.agents import RussianFluencyAgent, ChineseFluencyAgent
from kttc.llm import OpenAIProvider

provider = OpenAIProvider(api_key="your-key")

# Русский агент автоматически загружает grammar_reference.json
russian_agent = RussianFluencyAgent(provider)

# Китайский агент автоматически загружает classifiers.json
chinese_agent = ChineseFluencyAgent(provider)
```

Конфигурация не требуется - глоссарии загружаются на основе типа агента.

### Обогащение Ошибок

Когда агенты обнаруживают ошибки, они автоматически обогащают описания ошибок определениями из глоссария:

```python
# Ошибка, обнаруженная агентом
error = {
    "category": "fluency",
    "subcategory": "grammar",
    "description": "Несоответствие падежа"
}

# После обогащения глоссарием
enriched_error = {
    "category": "fluency",
    "subcategory": "grammar",
    "description": "Несоответствие падежа. В русском языке прилагательные должны согласовываться с существительными в падеже, числе и роде. Родительный падеж используется после отрицаний, с числительными и для выражения принадлежности."
}
```

### Взвешивание MQM Оценок

Глоссарий MQM предоставляет веса категорий для подсчета оценок:

```python
from kttc.core.mqm import MQMScorer

# Загрузить веса из глоссария
scorer = MQMScorer(use_glossary_weights=True)

# Веса категорий из glossary/en/mqm_core.json:
# accuracy: 1.5 (более высокий штраф за ошибки точности)
# terminology: 1.2
# fluency: 1.0
# style: 0.8 (более низкий штраф за стилистические проблемы)
```

## Команды CLI

### Просмотр Содержимого Глоссария

```bash
# Список всех доступных глоссариев
kttc glossary list

# Просмотр конкретного глоссария
kttc glossary view --language ru --name grammar_reference

# Поиск в глоссарии
kttc glossary search --language zh --query "measure word"

# Просмотр в формате JSON
kttc glossary view --language en --name mqm_core --format json
```

### Команды Терминологии

```bash
# Проверка типа ошибки
kttc terminology validate --error-type "mistranslation" --language en

# Список категорий ошибок MQM
kttc terminology list-categories

# Получение определения ошибки
kttc terminology define --error-type "grammar" --language ru
```

## Формат Файлов Глоссария

Глоссарии хранятся как JSON файлы следующей структуры:

### Формат MQM Core

```json
{
  "metadata": {
    "name": "MQM Core Error Taxonomy",
    "version": "1.0",
    "language": "en",
    "description": "W3C Multidimensional Quality Metrics"
  },
  "categories": {
    "accuracy": {
      "weight": 1.5,
      "subcategories": {
        "mistranslation": {
          "definition": "Текст перевода не точно представляет исходный текст",
          "examples": ["кот → собака", "купить → продать"],
          "severity_guidelines": "Major или Critical"
        }
      }
    }
  }
}
```

### Языкоспецифичный Формат

```json
{
  "metadata": {
    "name": "Справочник Русской Грамматики",
    "version": "1.0",
    "language": "ru"
  },
  "cases": {
    "nominative": {
      "name": "Именительный",
      "usage": ["Подлежащее", "Именная часть сказуемого"],
      "question": "кто? что?",
      "examples": ["студент читает", "это книга"]
    }
  },
  "aspects": {
    "perfective": {
      "usage": "Завершенные действия, однократные события",
      "markers": ["приставки: по-, на-, с-"],
      "examples": ["написать письмо"]
    }
  }
}
```

## Расширенное Использование

### Пользовательские Глоссарии

Вы можете добавлять пользовательские глоссарии в директорию `glossaries/`:

```bash
# Создание пользовательского глоссария
mkdir -p glossaries/ru
cat > glossaries/ru/medical_terms.json <<EOF
{
  "metadata": {
    "name": "Медицинская Терминология",
    "version": "1.0",
    "language": "ru",
    "domain": "medical"
  },
  "terms": {
    "инфаркт_миокарда": {
      "definition": "Сердечный приступ",
      "synonyms": ["ИМ", "сердечный приступ"],
      "avoid": ["остановка сердца"]
    }
  }
}
EOF
```

### Программный Доступ

```python
from kttc.terminology import GlossaryManager

# Инициализация менеджера
manager = GlossaryManager()

# Загрузка глоссария
mqm_data = manager.load_glossary("ru", "mqm_core")

# Получение конкретного определения
definition = mqm_data["categories"]["accuracy"]["subcategories"]["mistranslation"]

# Проверка типа ошибки
is_valid, info = manager.validate_mqm_error("mistranslation", "ru")
```

### Отключение Обогащения Глоссарием

```python
from kttc.agents.parser import ErrorParser

# Парсинг без обогащения
errors = ErrorParser.parse_errors(
    response=llm_response,
    enrich_with_glossary=False  # Отключить обогащение
)

# Или использовать веса по умолчанию для MQM оценки
from kttc.core.mqm import MQMScorer

scorer = MQMScorer(use_glossary_weights=False)  # Использовать веса по умолчанию
```

## Преимущества

### 1. Улучшенная Точность

Глоссарии предоставляют точные лингвистические определения, которые помогают агентам:
- Более точно идентифицировать языкоспецифичные ошибки
- Понимать грамматические паттерны и правила
- Валидировать использование терминологии

### 2. Лучшие Описания Ошибок

Обогащенные описания ошибок включают:
- Лингвистические объяснения
- Грамматические правила
- Примеры использования
- Исправления

### 3. Согласованная Оценка

Глоссарий MQM обеспечивает:
- Стандартизированную таксономию ошибок
- Согласованные веса категорий
- Воспроизводимые оценки качества
- Соответствие индустриальным стандартам (W3C MQM)

### 4. Поддержка Многих Языков

Одна и та же структура глоссариев работает для:
- 5 языков (en, ru, zh, hi, fa)
- Множественных категорий ошибок
- Языкоспецифичных особенностей
- Культурных адаптаций

## Расположение Файлов

```
glossaries/
├── en/
│   └── mqm_core.json          # Английские определения MQM
├── ru/
│   ├── mqm_core.json          # Русские определения MQM
│   └── grammar_reference.json # Правила русской грамматики
├── zh/
│   ├── mqm_core.json          # Китайские определения MQM
│   └── classifiers.json       # Китайские счетные слова
├── hi/
│   ├── mqm_core.json          # Определения MQM на хинди
│   └── grammar_reference.json # Правила грамматики хинди
└── fa/
    ├── mqm_core.json          # Персидские определения MQM
    └── grammar_reference.json # Правила персидской грамматики
```

## Связанная Документация

- **[Команды CLI](../reference/cli-commands.md)** - Команды глоссария и терминологии
- **[Архитектура](../explanation/architecture.md)** - Как глоссарии интегрируются с агентами
- **[Языковые Особенности](language-features.md)** - Языкоспецифичные возможности

## Устранение Неполадок

### Глоссарий Не Загружается

**Проблема:** Агент не использует данные глоссария

**Решение:**
```python
# Проверка существования файла глоссария
import os
glossary_path = "glossaries/ru/grammar_reference.json"
print(f"Существует: {os.path.exists(glossary_path)}")

# Включение отладочного логирования
import logging
logging.basicConfig(level=logging.DEBUG)
```

### Пользовательский Глоссарий Не Найден

**Проблема:** Пользовательский глоссарий не загружается

**Решение:**
- Убедитесь, что файл в правильной директории: `glossaries/{язык}/{имя}.json`
- Проверьте корректность синтаксиса JSON
- Убедитесь, что секция metadata присутствует

### Обогащение Ошибок Не Работает

**Проблема:** Ошибки не обогащаются определениями

**Решение:**
```python
# Явно включить обогащение
from kttc.agents.parser import ErrorParser

errors = ErrorParser.parse_errors(
    response=response,
    enrich_with_glossary=True,  # Явно включить
    language="ru"  # Указать язык
)
```

## Производительность

**Загрузка Глоссария:**
- Время загрузки: <100мс на глоссарий
- Использование памяти: ~1-5МБ на глоссарий
- Кэшируется после первой загрузки

**Обогащение Ошибок:**
- Время поиска: <1мс на ошибку
- Не требуется API вызовов
- Детерминированные результаты

## Будущие Улучшения

Планируемые функции глоссариев:
- Редактируемые пользователем глоссарии через веб-интерфейс
- Доменоспецифичные глоссарии (юридический, медицинский, технический)
- Контроль версий глоссариев
- Глоссарии от сообщества
- Слияние глоссариев и разрешение конфликтов
