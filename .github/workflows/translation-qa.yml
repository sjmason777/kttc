name: Translation QA

on:
  pull_request:
    paths:
      - 'translations/**'
      - 'locales/**'
      - 'i18n/**'
      - '**/*.po'
      - '**/*.pot'
      - '**/*.xliff'

  workflow_dispatch:
    inputs:
      source-dir:
        description: 'Source translations directory'
        required: true
        default: 'translations/source'
      translation-dir:
        description: 'Target translations directory'
        required: true
        default: 'translations/target'
      source-lang:
        description: 'Source language code (e.g., en)'
        required: true
        default: 'en'
      target-lang:
        description: 'Target language code (e.g., es)'
        required: true
        default: 'es'
      threshold:
        description: 'Minimum MQM score threshold'
        required: false
        default: '95.0'

jobs:
  check-translations:
    name: Check Translation Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install KTTC
        run: |
          pip install --upgrade pip
          pip install kttc

      - name: Run batch translation check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          kttc batch \
            --source-dir "${{ inputs.source-dir || 'translations/source' }}" \
            --translation-dir "${{ inputs.translation-dir || 'translations/target' }}" \
            --source-lang "${{ inputs.source-lang || 'en' }}" \
            --target-lang "${{ inputs.target-lang || 'es' }}" \
            --threshold ${{ inputs.threshold || '95.0' }} \
            --output qa-report.json \
            --parallel 4

      - name: Generate Markdown report
        if: always()
        run: |
          kttc report qa-report.json --format markdown --output qa-report.md

      - name: Upload QA report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-qa-report
          path: |
            qa-report.json
            qa-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üåê Translation Quality Report\n\n';

            try {
              const reportData = JSON.parse(fs.readFileSync('qa-report.json', 'utf8'));
              const summary = reportData.summary;

              const passIcon = summary.failed === 0 ? '‚úÖ' : '‚ùå';
              const statusText = summary.failed === 0 ? 'ALL PASS' : `${summary.failed} FAILED`;

              comment += `### ${passIcon} Status: ${statusText}\n\n`;
              comment += `| Metric | Value |\n`;
              comment += `|--------|-------|\n`;
              comment += `| Total Files | ${summary.total_files} |\n`;
              comment += `| Passed | ‚úÖ ${summary.passed} |\n`;
              comment += `| Failed | ‚ùå ${summary.failed} |\n`;
              comment += `| Average MQM Score | ${summary.average_score.toFixed(2)}/100 |\n`;
              comment += `| Quality Threshold | ${summary.threshold}/100 |\n`;
              comment += `| Total Errors | ${summary.total_errors} |\n\n`;

              if (reportData.files && reportData.files.length > 0) {
                comment += `### üìÑ File Results\n\n`;
                comment += `| File | Status | MQM Score | Errors |\n`;
                comment += `|------|--------|-----------|--------|\n`;

                for (const file of reportData.files.slice(0, 10)) {
                  const icon = file.status === 'pass' ? '‚úÖ' : '‚ùå';
                  comment += `| ${file.filename} | ${icon} | ${file.mqm_score.toFixed(2)} | ${file.error_count} |\n`;
                }

                if (reportData.files.length > 10) {
                  comment += `\n*... and ${reportData.files.length - 10} more files*\n`;
                }
              }

              comment += `\nüìä [View full report](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;

            } catch (error) {
              comment += `‚ö†Ô∏è Could not parse QA report: ${error.message}\n`;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if quality threshold not met
        if: always()
        run: |
          if [ -f qa-report.json ]; then
            FAILED=$(jq -r '.summary.failed' qa-report.json)
            if [ "$FAILED" != "0" ]; then
              echo "‚ùå Translation quality check failed: $FAILED file(s) below threshold"
              exit 1
            fi
            echo "‚úÖ All translations passed quality check"
          else
            echo "‚ö†Ô∏è No report generated"
            exit 1
          fi
