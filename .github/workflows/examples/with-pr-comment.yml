# Example: Quality check with PR comment
# This workflow checks translations and posts results as PR comment

name: Translation QA - With PR Comment

on:
  pull_request:
    paths:
      - 'translations/**'

jobs:
  check-and-comment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run KTTC quality check
        id: kttc
        uses: ./
        with:
          source-dir: 'translations/source'
          translation-dir: 'translations/target'
          source-lang: 'en'
          target-lang: 'es'
          threshold: '95.0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = '${{ steps.kttc.outputs.report-path }}';

            let comment = '## üåê KTTC Translation Quality Report\n\n';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const summary = report.summary;

              const statusIcon = summary.failed === 0 ? '‚úÖ' : '‚ùå';
              const statusText = summary.failed === 0 ? 'PASS' : 'FAIL';

              comment += `### ${statusIcon} Status: ${statusText}\n\n`;
              comment += `| Metric | Value |\n`;
              comment += `|--------|-------|\n`;
              comment += `| Average MQM Score | **${summary.average_score.toFixed(2)}/100** |\n`;
              comment += `| Files Checked | ${summary.total_files} |\n`;
              comment += `| Passed | ‚úÖ ${summary.passed} |\n`;
              comment += `| Failed | ‚ùå ${summary.failed} |\n`;
              comment += `| Total Errors | ${summary.total_errors} |\n\n`;

              if (summary.failed > 0) {
                comment += '### ‚ö†Ô∏è Files below threshold:\n\n';
                for (const file of report.files.filter(f => f.status === 'fail')) {
                  comment += `- **${file.filename}**: ${file.mqm_score.toFixed(2)}/100 (${file.error_count} errors)\n`;
                }
              }
            } else {
              comment += '‚ö†Ô∏è Report file not found\n';
            }

            comment += `\n---\n*Powered by [KTTC](https://github.com/your-org/kttc)*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if quality check failed
        if: steps.kttc.outputs.status == 'fail'
        run: |
          echo "‚ùå Translation quality check failed"
          echo "  Total files: ${{ steps.kttc.outputs.total-files }}"
          echo "  Failed: ${{ steps.kttc.outputs.failed }}"
          echo "  MQM Score: ${{ steps.kttc.outputs.mqm-score }}"
          exit 1
