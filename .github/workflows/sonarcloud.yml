name: SonarCloud

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for accurate blame information

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/unit/ --cov=src/kttc --cov-report=xml:coverage.xml -v
        continue-on-error: true

      # Generate external analyzer reports for SonarCloud
      # See: https://docs.sonarcloud.io/enriching/external-analyzer-reports/

      - name: Run MyPy and generate report
        run: |
          python -m mypy --config-file pyproject.toml > mypy-report.txt 2>&1 || true
        continue-on-error: true

      - name: Run Pylint and generate report
        run: |
          python -m pylint src/kttc/ \
            --output-format=parseable \
            --msg-template="{path}:{line}: [{msg_id}({symbol}), {obj}] {msg}" \
            > pylint-report.txt 2>&1 || true
        continue-on-error: true

      - name: Run Bandit and generate report
        run: |
          python -m bandit -r src/kttc/ -f json -o bandit-report.json 2>&1 || true
        continue-on-error: true

      - name: Run Ruff and generate report
        run: |
          python -m ruff check src/ --output-format=text > ruff-report.txt 2>&1 || true
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
